generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  ATHLETE
  TRAINER
  ORGANIZATION_ADMIN
  SUPER_ADMIN
}

enum EventStatus {
  FUTURE
  COMPLETED
  CANCELLED
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

// Models

model Organization {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  users     User[]
  teams     Team[]

  @@map("organizations")
}

model User {
  id                 String       @id @default(uuid())
  name               String
  email              String       @unique
  password           String
  role               UserRole     @default(ATHLETE)
  isAdmin            Boolean      @default(false) @map("is_admin")
  gender             Gender?
  userType           String?      @map("user_type") // Deprecated: use role
  height             Int?         // cm
  weight             Int?         // kg
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")
  lastName           String?      @map("last_name")
  
  // Relations
  events             Event[]
  teamMemberships    TeamMember[]
  ownedTeams         Team[]       @relation("OwnedTeams")
  participatedEvents Event[]      @relation("EventParticipants")
  exercises          Exercise[]
  strengthResults    StrengthWorkoutResult[]
  eventResults       EventResult[]

  // Organization
  organizationId     String?       @map("organization_id")
  organization       Organization? @relation(fields: [organizationId], references: [id])
  organizationName   String?       @map("organization_name") // Deprecated: use organization relation

  dashboardLayout    String[]      @default(["exercise-tracker", "weight-tracker", "recent-activities"]) @map("dashboard_layout")
  dashboardLayoutMode String       @default("asymmetric") @map("dashboard_layout_mode")

  @@map("users")
}

model Exercise {
  id        String           @id @default(uuid())
  name      String
  userId    String           @map("user_id")
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  records   ExerciseRecord[]
  strengthResults StrengthWorkoutResult[]
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  @@map("exercises")
}

model ExerciseRecord {
  id         String   @id @default(uuid())
  weight     Float
  date       DateTime @default(now())
  exerciseId String   @map("exercise_id")
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("exercise_records")
}

model Event {
  id           String        @id @default(uuid())
  title        String
  description  String?
  eventDate    DateTime      @map("event_date")
  status       EventStatus   @default(FUTURE)
  exerciseType String?       @map("exercise_type")
  exercises    Json?
  userId       String        @map("user_id")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  results      EventResult[]
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  participants User[]        @relation("EventParticipants")
  timeCap      String?       @map("time_cap")
  rounds       String?
  teamId       String?       @map("team_id")
  team         Team?         @relation(fields: [teamId], references: [id])

  @@map("events")
}

model Team {
  id          String       @id @default(uuid())
  name        String
  description String?
  ownerId     String       @map("owner_id")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  members     TeamMember[]
  owner       User         @relation("OwnedTeams", fields: [ownerId], references: [id])
  events      Event[]

  organizationId String?       @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationName String?     @map("organization_name") // Deprecated: use organization relation

  @@map("teams")
}

model TeamMember {
  id     String   @id @default(uuid())
  teamId String   @map("team_id")
  userId String   @map("user_id")
  role   TeamRole @default(MEMBER)
  team   Team     @relation(fields: [teamId], references: [id])
  user   User     @relation(fields: [userId], references: [id])

  @@unique([teamId, userId])
  @@map("team_members")
}

model EventResult {
  id        String   @id @default(uuid())
  time      String
  dateAdded DateTime @default(now()) @map("date_added")
  eventId   String   @map("event_id")
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  // Relations
  userId    String?  @map("user_id")
  user      User?    @relation(fields: [userId], references: [id])
  username  String   // Kept for backward compatibility

  @@map("event_results")
}

model StrengthWorkoutResult {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  exerciseId String   @map("exercise_id")
  date       DateTime @default(now())
  week       Int
  weight     Float
  reps       Int
  createdAt  DateTime @default(now()) @map("created_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@map("strength_workout_results")
}
